<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BeatSaver Playlist Extractor</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
    }
    label {
      margin-right: 10px;
    }
    textarea {
      width: 100%;
      height: 300px;
      margin-top: 1rem;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>BeatSaver Playlist to Python</h1>
  <input type="text" id="playlistUrl" placeholder="Paste BeatSaver playlist URL">
  <br><br>
  <label><input type="checkbox" class="difficulty-filter" value="Easy" checked> Easy</label>
  <label><input type="checkbox" class="difficulty-filter" value="Normal" checked> Normal</label>
  <label><input type="checkbox" class="difficulty-filter" value="Hard" checked> Hard</label>
  <label><input type="checkbox" class="difficulty-filter" value="Expert" checked> Expert</label>
  <label><input type="checkbox" class="difficulty-filter" value="ExpertPlus" checked> ExpertPlus</label>
  <br><br>
  <button onclick="fetchPlaylist()">Generate</button>
  <pre id="output"></pre>

  <script>
    async function fetchPlaylist() {
      const urlInput = document.getElementById('playlistUrl').value.trim();
      const match = urlInput.match(/playlists\/(\d+)/);
      const playlistId = match ? match[1] : null;
      if (!playlistId) {
        document.getElementById('output').textContent = "Invalid URL!";
        return;
      }

      const selectedDifficulties = Array.from(document.querySelectorAll('.difficulty-filter:checked')).map(cb => cb.value);

      let page = 0;
      let hasMore = true;
      const songDict = {};

      while (hasMore) {
        const res = await fetch(`https://api.beatsaver.com/playlists/id/${playlistId}/${page}`);
        if (!res.ok) {
          document.getElementById('output').textContent = "Error fetching playlist data";
          return;
        }

        const data = await res.json();
        if (!data.maps || data.maps.length === 0) {
          hasMore = false;
          break;
        }

        for (const item of data.maps) {
          const map = item.map;
          const metadata = map.metadata;
          const songTitle = `${metadata.songAuthorName} - ${metadata.songName}`;
          const version = map.versions[0];
          const levelId = version.key ?? map.id ?? "UNKNOWN";

          for (const diff of version.diffs) {
            if (!selectedDifficulties.includes(diff.difficulty)) continue;

            const fullTitle = `${songTitle} [${diff.difficulty}]`;
            songDict[fullTitle] = {
              levelid: levelId,
              difficulty: diffToNumber(diff.difficulty),
              characteristic: diff.characteristic
            };
          }
        }

        page++;
      }

      const lines = ['default_songs = {'];
      for (const [k, v] of Object.entries(songDict)) {
        lines.push(`    "${k}": {\n        levelid: "${v.levelid}",\n        difficulty: ${v.difficulty},\n        characteristic: "${v.characteristic}"\n    },`);
      }
      lines.push('}');

      document.getElementById('output').textContent = lines.join('\n');
    }

    function diffToNumber(diff) {
      const mapping = {
        Easy: 1,
        Normal: 2,
        Hard: 3,
        Expert: 4,
        ExpertPlus: 5
      };
      return mapping[diff] ?? 0;
    }
  </script>
</body>
</html>
