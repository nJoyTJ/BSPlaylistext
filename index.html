<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BeatSaver Playlist Parser</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 1rem; }
    textarea { width: 100%; height: 400px; font-family: monospace; }
  </style>
</head>
<body>
  <h1>BeatSaver Playlist to Python Dictionary</h1>
  <input id="playlistUrl" type="text" placeholder="Enter BeatSaver playlist URL" size="80" />
  <button onclick="fetchPlaylist()">Convert</button>
  <h2>Output:</h2>
  <textarea id="output" readonly></textarea>

  <script>
  async function fetchPlaylist() {
    const input = document.getElementById("playlistUrl").value.trim();
    const match = input.match(/\/playlists\/([^/]+)/);
    if (!match) {
      alert("Invalid URL");
      return;
    }

    const playlistId = match[1];
    const outputBox = document.getElementById("output");
    outputBox.value = "Loading...";

    let page = 0;
    let allMaps = [];

    try {
      // Fetch all paginated maps
      while (true) {
        const apiUrl = `https://api.beatsaver.com/playlists/id/${playlistId}/${page}`;
        const response = await fetch(apiUrl);
        if (!response.ok) break;

        const data = await response.json();
        const maps = data.maps || [];

        if (maps.length === 0) break;

        allMaps.push(...maps);
        page++;
      }

      if (allMaps.length === 0) {
        outputBox.value = "default_songs = {}";
        return;
      }

      const lines = ['default_songs = {'];

      for (const mapEntry of allMaps) {
        const map = mapEntry.map;
        const metadata = map.metadata || {};
        const songTitle = `${metadata.songAuthorName} - ${metadata.songName}`;
        const fullTitle = `[${data.playlist.name}] ${songTitle}`;
        const versions = map.versions || [];

        let levelid = "UNKNOWN";
        let diffNumeric = 0;
        let characteristic = "Standard";

        if (versions.length > 0) {
          const version = versions[0];
          levelid = version.key || "UNKNOWN";

          const diffObj = version.diffs?.find(d => d.characteristic === "Standard") || version.diffs?.[0];
          if (diffObj) {
            characteristic = diffObj.characteristic || "Standard";
            const difficultyMap = {
              Easy: 1, Normal: 2, Hard: 3, Expert: 4, ExpertPlus: 5
            };
            diffNumeric = difficultyMap[diffObj.difficulty] || 0;
          }
        }

        lines.push(`    "${fullTitle}": {`);
        lines.push(`        "levelid": "${levelid}",`);
        lines.push(`        "difficulty": ${diffNumeric},`);
        lines.push(`        "characteristic": "${characteristic}"`);
        lines.push(`    },`);
      }

      lines.push("}");
      outputBox.value = lines.join("\n");

    } catch (err) {
      console.error(err);
      alert("Error fetching playlist data");
      outputBox.value = "default_songs = {}";
    }
  }
  </script>
</body>
</html>
